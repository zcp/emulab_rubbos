<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN"><HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1"><META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css"><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 6.0/HTML Export Filter"><LINK REL="STYLESHEET" HREF="CMP-RI.css" CHARSET="ISO-8859-1" TYPE="text/css"><TITLE> by Beth Stearns</TITLE></HEAD><BODY BGCOLOR="#ffffff"><P CLASS="Chapter-Title"><A NAME="pgfId-65260"></A>CMP 2.0 Bean Example</P><DIV><H2 CLASS="Author"><A NAME="pgfId-65261"></A>by Beth Stearns<EM CLASS="Hypertext"></EM></H2></DIV><DIV><H1 CLASS="B-Head"><A NAME="pgfId-65303"></A>CMP Example Overview</H1><P CLASS="Body"><A NAME="pgfId-65304"></A>The CMP 2.0 example models an application that maintains customers, addresses, and customer publication subscriptions in a database. Customers may have multiple addresses and may subscribe to multiple publications. Publications are classified according to type: magazines, newspapers, journals, and so forth.</P><P CLASS="Body"><A NAME="pgfId-67072"></A>You can find the example application files beneath the /j2ee directory in which you've installed the release. The .ear file for the application, cmpcustomer.ear, and it is found in the directory:</P><pre>../j2ee/doc/samples/cmpcustomer.ear</pre><P CLASS="Body"><A NAME="pgfId-67081"></A>The directory <Code>../j2ee/doc/samples/customer</code> contains the Java source files for the different entity beans, while the directory <Code>../j2ee/doc/samples/contentRoot</code> contains the JSP files for the application.</P><P CLASS="Body"><A NAME="pgfId-65444"></A>The example application appears in the deploytool within the Applications folder. It is called CMPCustomerApp. If you expand CMPCustomerApp, you'll see it has a web section and an Ejb1 section. Expand the web section to see the JSPs defined for this application. Expand Ejb1 to see the application' s three entity beans.</P><P CLASS="Body"><A NAME="pgfId-67151"></A>The example uses three entity beans: a Customer bean, an Address bean, and a Subscription bean. Each customer is represented by an instance of the Customer bean. Each customer may have one or more addresses, and each address is represented by an instance of an Address bean and associated to the particular customer. The relationship between customers and addresses is a one-to-many, uni-directional aggregation. You may add and delete individual addresses for a customer, but, because an address instance must be associated to a customer, when you delete a customer, you are also automatically deleting all addresses associated to that customer. The example illustrates the architecture's cascade delete functionality because it automatically ensures that all address instances associated with a customer instance are deleted when the customer instance is removed.</P><P CLASS="Body"><A NAME="pgfId-65462"></A>There is also a many-to-many, bi-directional association between the Customer bean and the Subscription bean. A customer may have zero or more subscriptions, where each Subscription instance represents a different publication. Similarly, a single Subscription instance may be associated to many customers.</P><P CLASS="Body"><A NAME="pgfId-65480"></A>Lastly, each subscription instance has an attribute, subscription type, indicating its type, such as magazine or journal. When you create a new subscription, you designate its type. The subscription type is a separate class, SubscriptionType, and is considered a dependent value class. It is not an enterprise bean. The Subscription bean references it as a container-managed persistent field.</P></DIV></DIV><DIV><H1 CLASS="B-Head"><A NAME="pgfId-66952"></A>Defining the CMP Relationships</H1><P CLASS="Body"><A NAME="pgfId-66519"></A>The deployment descriptor contains the enterprise bean relationship definitions. The CMP 2.0 example has already been set up with a deployment descriptor, which is contained in the .ear file. When you open the example in the deploytool, the tool shows you all of the relationship mappings, container-managed persistent fields, and so forth. It is not necessary for you to add or change any of these associations. However, if you were writing your own application, you use the deploytool screens to designate the cmp fields and bean relationships. It is important that you follow what has been done in the enterprise bean code when you make these designations. That is, the deploytool mappings must mirror the code. Otherwise, your application may not run properly.</P><P CLASS="Body"><A NAME="pgfId-67126"></A>Here, we describe how you define relationships in the code and then show you how to set up these same relationships using the deploytool.</P><DIV><H3 CLASS="C-Head"><A NAME="pgfId-66870"></A>Defining Many-to-Many Relationships</H3><P CLASS="Body"><A NAME="pgfId-67197"></A>The Customer bean to Subscription bean is a good example of defining a many-to-many relationship. The Customer bean has a many-to-many bi-directional relationship to Subscriptions. Thus, the Customer bean includes two methods: one to return all subscriptions associated to a single customer and the other to update a customer's subscriptions:</P><DIV><pre>public abstract Collection getSubscriptions(); public abstract void setSubscriptions (Collection subscriptions);</pre><P CLASS="Body"><A NAME="pgfId-67200"></A>The Subscription bean includes equivalent methods to retrieve and set all customers associated to a particular subscription instance:</P></DIV><DIV><pre>public abstract Collection getCustomers();public abstract void setCustomers(Collection customers); </Pre><P CLASS="Body"><A NAME="pgfId-67210"></A>Define this relationship in the deploytool as follows:</P><DIV><ol><li>Highlight the Ejb1 JAR file. (This JAR file appears beneath CMPCustomerApp.) </li><li>Select the Relationships tab. </LI><LI>Highlight the Customer bean to Subscription bean relationship.</LI><LI>Select Edit to bring up the Edit Relationship screen.</LI><LI>From the Multiplicity pull-down menu, select Many to Many. </LI><LI>For Enterprise Bean A, select CustomerBean. </LI><LI>For its Field Referencing Bean B, choose <Code>subscriptions</code> from the list of fields. </LI><LI>For Enterprise Bean B, select SubscriptionBean from the list of beans. </LI><LI>For its Field Referencing Bean A, choose <Code>customers</code>.</LI><LI>Select OK to complete the relationship set up.</LI></oL></DIV></DIV></DIV><DIV><H3 CLASS="C-Head"><A NAME="pgfId-66847"></A>Defining One-to-Many Relationships</H3><P CLASS="Body"><A NAME="pgfId-67256"></A>In the code, a local bean object represents the single side of a one-to-many relationship. A Java Collection of local objects represents the many side. For example, the CustomerBean defines the method <Code>getAddresses</code> to retrieve all the addresses for one customer and the method <Code>setAddresses</code> to set all addresses: </P><pre>public abstract Collection getAddresses();public abstract void setAddresses (Collection addresses);</Pre><P CLASS="Body"><A NAME="pgfId-67259"></A>Because the Customer to Address relationship is only in one direction, the Address bean does not define a method to get an address instance's associated customer.</P><P CLASS="Body"><A NAME="pgfId-66838"></A>Set up the one-to-many relationship between the Customer bean and the Address bean in the deploytool as follows. </P><DIV><ol><li>Highlight the Ejb1 JAR file. (This JAR file appears beneath CMPCustomerApp.) </li><LI>Select the Relationships tab. </LI><LI>Highlight the Customer bean to Address bean relationship.</LI><LI>Select Edit to bring up the Edit Relationship screen.</LI><LI>From the Multiplicity pull-down menu, select One to Many. </LI><LI>For Enterprise Bean A, select CustomerBean. </LI><LI>For its Field Referencing Bean B, choose <Code>addresses</code> from the pull-down menu. </LI><LI >For Enterprise Bean B, select AddressBean from the list of beans. </LI><LI>For its Field Referencing Bean A, choose none (because AddressBean does not contain any references to the Customer bean).</LI><LI>Select OK to complete the relationship set up.</LI></OL></DIV></DIV><DIV><H4 CLASS="D-Head"><A NAME="pgfId-66851"></A>Setting the Cascade Delete Functionality</H4><P CLASS="Body"><A NAME="pgfId-66858"></A>Set cascade delete functionality from the same Customer to Address Edit Relationship screen. Notice that the box to Delete When Bean A is checked for AddressBean in the Customer to Address bean Edit Relationship screen. When this box is checked and the application deletes an instance of a Customer bean, the container ensures that all instances of the Address bean that are associated to the deleted Customer object are also deleted.</P></DIV></DIV><DIV><H3 CLASS="C-Head"><A NAME="pgfId-66899"></A>Setting CMP Fields</H3><P CLASS="Body"><A NAME="pgfId-66900"></A>The deployment descriptor must correctly indicate the cmp fields for the entity beans using container-managed persistence. </P><P CLASS="Body"><A NAME="pgfId-67346"></A>For example, the CustomerBean uses container-managed persistence (2.0). It uses container-manager persistence for three of its five fields: <Code>customerID</code>, <Code>firstName</code>, and <Code>lastName</Code>. These checked fields correspond to the cmp fields for which the CustomerBean provides get and set methods.</P><DIV><pre>	public abstract String getCustomerID();public abstract void setCustomerID(String id);	public abstract String getFirstName(); public abstract void setFirstName(String firstName);public abstract String getLastName();public abstract void setLastName(String lastName);</Pre><P CLASS="Body"><A NAME="pgfId-67339"></A>Do the following in the deploytool to set the cmp fields. </P><DIV><ol><li>Select the CustomerBean entity bean (listed beneath the Ejb1 JAR file).</li><LI>Select the Entity tab. </LI><LI>Check the type of persistence management for the bean. CustomerBean uses container-managed persistence (2.0). </LI><LI>Check the three CustomerBean fields (<Code>customerID</Code>, <Code>firstName</Code>, and <Code>lastName</Code>) to be persisted. </LI></OL></DIV></DIV></DIV></DIV><DIV><H1 CLASS="B-Head"><A NAME="pgfId-67044"></A>Running the Sample Application</H1><P CLASS="Body"><A NAME="pgfId-67045"></A>Before you can run the sample application, be sure that the application has been deployed and that the enterprise bean SQL code has been generated. Use the deploytool's Deploy function (available from the Tools menu) to deploy the application. </P><P CLASS="Body"><A NAME="pgfId-67114"></A>To generate the SQL:</P><DIV><ol><li>Select Ejb1 beneath the CMPCustomerApp application. </li><LI>Select the General tab.</LI><LI>Select Deployment Settings. </LI><LI>From the Deployment Settings screen, select Generate SQL Now. This operation generates the SQL statements.</LI></OL><P CLASS="Body"><A NAME="pgfId-67057"></A>You may now run the application. From a browser window, enter the following location:</P></DIV><DIV><pre>http://localhost:8000/customer</pre><P CLASS="Body"><A NAME="pgfId-67059"></A>This starts the application and opens its main window. From this window, you can create new customers and subscriptions, search for existing customers and subscriptions, and search for addresses. When you add a new customer, you have the option to add addresses for that customer. Notice, too, that when you delete a particular customer, you also delete all addresses associated to that customer.</P><P CLASS="Body"><A NAME="pgfId-65564"></A>&nbsp;</P></DIV></DIV></BODY></HTML>